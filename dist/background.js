import{S as o,a as l,D as S}from"./constants.js";async function g(){return(await chrome.storage.sync.get(o.CONFIG))[o.CONFIG]||S}async function k(t){await chrome.storage.sync.set({[o.CONFIG]:t})}async function d(){return(await chrome.storage.local.get(o.STATE))[o.STATE]||l}async function T(t){await chrome.storage.local.set({[o.STATE]:t})}async function c(t){const a={...await d(),...t};return await T(a),a}let u=null;function A(t,e){f(),u=setTimeout(t,e*1e3)}function f(){u!==null&&(clearTimeout(u),u=null)}let n=null,r=null,m=!1;function C(t){return`${new URL(t).origin}/s/checkout`}function y(t,e){chrome.notifications.create({type:"basic",iconUrl:"assets/icon-128.png",title:t,message:e})}function h(t){chrome.runtime.sendMessage({type:"STATE_UPDATE",payload:t}).catch(()=>{})}async function E(t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]})}catch(e){console.error("Failed to inject content script:",e)}}async function _(t){const e=t==="clicked",a=t!==void 0,b=await c({lastRefreshTime:Date.now(),lastError:null,successDetected:!0,addedToCart:e,clickAttempted:a});let s,i;if(t==="clicked"){if(s="Added to Cart!",i="The product was automatically added to your cart!",n!==null&&r){m=!0;const p=C(r);chrome.tabs.update(n,{url:p})}}else t==="click_failed"?(s="Product Available!",i="Product is available but auto-click failed. Check the tab."):(s="Product Available!",i='The product has an "Add to Cart" button - it may be available!');y(s,i),h(b),f()}async function v(){const t=await c({lastRefreshTime:Date.now(),lastError:"out_of_stock",successDetected:!1});y("Item Out of Stock","The product page exists but shows out of stock."),h(t),f()}async function I(){const t=await g(),e=await d(),a=await c({lastRefreshTime:Date.now(),attemptCount:e.attemptCount+1,lastError:"not_found",successDetected:!1});h(a),a.isMonitoring&&n!==null&&A(()=>M(),t.intervalSeconds)}async function M(){if(n!==null)try{await chrome.tabs.reload(n)}catch{await w()}}function O(){chrome.webNavigation.onCompleted.addListener(async t=>{if(t.tabId!==n||t.frameId!==0)return;if(m&&t.url.includes("/s/checkout")){m=!1;const a=await c({navigatedToCheckout:!0});h(a),y("Ready for checkout!","You are now on the checkout page. Complete your purchase!");return}r&&!t.url.startsWith(r)||!(await d()).isMonitoring||await E(t.tabId)}),chrome.runtime.onMessage.addListener((t,e)=>{var a;if(!(t.type!=="PAGE_STATUS"||((a=e.tab)==null?void 0:a.id)!==n))switch(t.status){case"available":_(t.clickResult);break;case"out_of_stock":v();break;case"not_found":I();break}})}chrome.tabs.onRemoved.addListener(async t=>{t===n&&await w()});async function D(t){await w(),r=t.url;const e=await chrome.tabs.create({url:t.url,active:!0});if(!e.id)throw new Error("Failed to create tab");return n=e.id,await c({isMonitoring:!0,tabId:e.id,lastRefreshTime:Date.now(),attemptCount:1,lastError:null,successDetected:!1})}async function w(){return f(),n=null,r=null,await c({...l})}O();chrome.runtime.onMessage.addListener((t,e,a)=>(N(t).then(a),!0));async function N(t){switch(t.type){case"START_MONITORING":{const e=t.payload;return await k(e),await D(e)}case"STOP_MONITORING":return await w();case"GET_STATE":{const e=await d(),a=await g();return{state:e,config:a}}default:return null}}chrome.runtime.onStartup.addListener(async()=>{await T(l)});chrome.runtime.onInstalled.addListener(async()=>{await T(l)});console.log("Website Availability Monitor service worker started");
